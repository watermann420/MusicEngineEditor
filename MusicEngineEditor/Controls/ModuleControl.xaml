<UserControl x:Class="MusicEngineEditor.Controls.ModuleControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:MusicEngineEditor.ViewModels"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:ModuleViewModel}"
             d:DesignWidth="120" d:DesignHeight="180">

    <UserControl.Resources>
        <!-- Colors -->
        <Color x:Key="ModuleBackgroundColor">#1E1E1E</Color>
        <Color x:Key="ModuleHeaderColor">#252525</Color>
        <Color x:Key="ModuleBorderColor">#3A3A3A</Color>
        <Color x:Key="ModuleSelectedBorderColor">#00D9FF</Color>
        <Color x:Key="TextPrimaryColor">#E0E0E0</Color>
        <Color x:Key="TextSecondaryColor">#808080</Color>
        <Color x:Key="PortAudioColor">#00D9FF</Color>
        <Color x:Key="PortCVColor">#FFA500</Color>
        <Color x:Key="PortGateColor">#00FF88</Color>
        <Color x:Key="PortTriggerColor">#FF6B6B</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="ModuleBackgroundBrush" Color="{StaticResource ModuleBackgroundColor}"/>
        <SolidColorBrush x:Key="ModuleHeaderBrush" Color="{StaticResource ModuleHeaderColor}"/>
        <SolidColorBrush x:Key="ModuleBorderBrush" Color="{StaticResource ModuleBorderColor}"/>
        <SolidColorBrush x:Key="ModuleSelectedBorderBrush" Color="{StaticResource ModuleSelectedBorderColor}"/>
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="{StaticResource TextPrimaryColor}"/>
        <SolidColorBrush x:Key="TextSecondaryBrush" Color="{StaticResource TextSecondaryColor}"/>

        <!-- Port Style -->
        <Style x:Key="PortButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Ellipse x:Name="PortOuter"
                                     Fill="#2A2A2A"
                                     Stroke="{TemplateBinding Background}"
                                     StrokeThickness="2"/>
                            <Ellipse x:Name="PortInner"
                                     Width="6" Height="6"
                                     Fill="{TemplateBinding Background}"
                                     Visibility="Collapsed"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="Tag" Value="True">
                                <Setter TargetName="PortInner" Property="Visibility" Value="Visible"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="PortOuter" Property="StrokeThickness" Value="3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Parameter Slider Style -->
        <Style x:Key="ParameterSliderStyle" TargetType="Slider">
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="1"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="Background" Value="#2A2A2A"/>
            <Setter Property="Foreground" Value="#00D9FF"/>
        </Style>
    </UserControl.Resources>

    <Border x:Name="ModuleBorder"
            Background="{StaticResource ModuleBackgroundBrush}"
            BorderBrush="{StaticResource ModuleBorderBrush}"
            BorderThickness="1"
            CornerRadius="6"
            Effect="{x:Null}">
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                        <Setter Property="BorderBrush" Value="{StaticResource ModuleSelectedBorderBrush}"/>
                        <Setter Property="BorderThickness" Value="2"/>
                        <Setter Property="Effect">
                            <Setter.Value>
                                <DropShadowEffect Color="#00D9FF" BlurRadius="10" ShadowDepth="0" Opacity="0.5"/>
                            </Setter.Value>
                        </Setter>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>

        <Grid>
            <Grid.RowDefinitions>
                <!-- Header -->
                <RowDefinition Height="32"/>
                <!-- Ports and Parameters -->
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Module Header -->
            <Border Grid.Row="0"
                    Background="{StaticResource ModuleHeaderBrush}"
                    CornerRadius="6,6,0,0"
                    Padding="8,4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Module Type Icon -->
                    <Border Grid.Column="0"
                            Width="20" Height="20"
                            CornerRadius="4"
                            Margin="0,0,6,0">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#00D9FF"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="VCO">
                                        <Setter Property="Background" Value="#00D9FF"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="VCF">
                                        <Setter Property="Background" Value="#FF6B9D"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="VCA">
                                        <Setter Property="Background" Value="#7B68EE"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="LFO">
                                        <Setter Property="Background" Value="#FFA500"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="ADSR">
                                        <Setter Property="Background" Value="#00FF88"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="Mixer">
                                        <Setter Property="Background" Value="#FF6B6B"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ModuleType}" Value="Output">
                                        <Setter Property="Background" Value="#FFFFFF"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding ModuleType, Converter={x:Null}}"
                                   FontSize="8"
                                   FontWeight="Bold"
                                   Foreground="#0D0D0D"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"/>
                    </Border>

                    <!-- Module Name -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding Name}"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="11"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"/>
                </Grid>
            </Border>

            <!-- Content Area -->
            <Grid Grid.Row="1" Margin="4">
                <Grid.ColumnDefinitions>
                    <!-- Input Ports -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- Parameters -->
                    <ColumnDefinition Width="*"/>
                    <!-- Output Ports -->
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Input Ports -->
                <ItemsControl Grid.Column="0"
                              ItemsSource="{Binding Inputs}"
                              VerticalAlignment="Top"
                              Margin="-6,4,0,0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Vertical"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:PortViewModel}">
                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                <Button x:Name="InputPortButton"
                                        Style="{StaticResource PortButtonStyle}"
                                        Background="{Binding PortColor}"
                                        Tag="{Binding IsConnected}"
                                        ToolTip="{Binding Name}"
                                        Click="OnPortClick"/>
                                <TextBlock Text="{Binding Name}"
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="9"
                                           VerticalAlignment="Center"
                                           Margin="2,0,0,0"
                                           MaxWidth="40"
                                           TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Parameters -->
                <ScrollViewer Grid.Column="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              Margin="4,4">
                    <ItemsControl ItemsSource="{Binding Parameters}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Vertical"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:ParameterViewModel}">
                                <StackPanel Margin="0,2">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding Name}"
                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                   FontSize="9"
                                                   TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Value, StringFormat='{}{0:F2}'}"
                                                   Foreground="{StaticResource TextPrimaryBrush}"
                                                   FontSize="9"
                                                   Margin="4,0,0,0"/>
                                    </Grid>
                                    <Slider Value="{Binding Value}"
                                            Minimum="{Binding MinValue}"
                                            Maximum="{Binding MaxValue}"
                                            Style="{StaticResource ParameterSliderStyle}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Output Ports -->
                <ItemsControl Grid.Column="2"
                              ItemsSource="{Binding Outputs}"
                              VerticalAlignment="Top"
                              Margin="0,4,-6,0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Vertical"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:PortViewModel}">
                            <StackPanel Orientation="Horizontal" Margin="0,2" HorizontalAlignment="Right">
                                <TextBlock Text="{Binding Name}"
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="9"
                                           VerticalAlignment="Center"
                                           Margin="0,0,2,0"
                                           MaxWidth="40"
                                           TextTrimming="CharacterEllipsis"/>
                                <Button x:Name="OutputPortButton"
                                        Style="{StaticResource PortButtonStyle}"
                                        Background="{Binding PortColor}"
                                        Tag="{Binding IsConnected}"
                                        ToolTip="{Binding Name}"
                                        Click="OnPortClick"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Grid>
    </Border>
</UserControl>
