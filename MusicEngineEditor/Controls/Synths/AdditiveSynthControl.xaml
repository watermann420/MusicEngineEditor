<UserControl x:Class="MusicEngineEditor.Controls.Synths.AdditiveSynthControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:MusicEngineEditor.Controls.Synths"
             xmlns:vm="clr-namespace:MusicEngineEditor.ViewModels.Synths"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200"
             d:DataContext="{d:DesignInstance Type=vm:AdditiveSynthViewModel}"
             Background="#0D0D0D">

    <UserControl.Resources>
        <!-- Dark Theme Colors -->
        <Color x:Key="BackgroundColor">#0D0D0D</Color>
        <Color x:Key="PanelColor">#181818</Color>
        <Color x:Key="PanelLightColor">#1E1E1E</Color>
        <Color x:Key="BorderColor">#2A2A2A</Color>
        <Color x:Key="AccentColor">#00D9FF</Color>
        <Color x:Key="SuccessColor">#00FF88</Color>
        <Color x:Key="TextColor">#E0E0E0</Color>
        <Color x:Key="TextDimColor">#808080</Color>
        <Color x:Key="OddHarmonicColor">#FF6B6B</Color>
        <Color x:Key="EvenHarmonicColor">#6BCF6B</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="BackgroundBrush" Color="{StaticResource BackgroundColor}"/>
        <SolidColorBrush x:Key="PanelBrush" Color="{StaticResource PanelColor}"/>
        <SolidColorBrush x:Key="PanelLightBrush" Color="{StaticResource PanelLightColor}"/>
        <SolidColorBrush x:Key="BorderBrush" Color="{StaticResource BorderColor}"/>
        <SolidColorBrush x:Key="AccentBrush" Color="{StaticResource AccentColor}"/>
        <SolidColorBrush x:Key="SuccessBrush" Color="{StaticResource SuccessColor}"/>
        <SolidColorBrush x:Key="ForegroundBrush" Color="{StaticResource TextColor}"/>
        <SolidColorBrush x:Key="TextDimBrush" Color="{StaticResource TextDimColor}"/>
        <SolidColorBrush x:Key="OddHarmonicBrush" Color="{StaticResource OddHarmonicColor}"/>
        <SolidColorBrush x:Key="EvenHarmonicBrush" Color="{StaticResource EvenHarmonicColor}"/>

        <!-- Hammond Drawbar Colors -->
        <SolidColorBrush x:Key="DrawbarBrownBrush" Color="#8B4513"/>
        <SolidColorBrush x:Key="DrawbarWhiteBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="DrawbarBlackBrush" Color="#333333"/>

        <!-- Slider Style -->
        <Style x:Key="DarkSliderStyle" TargetType="Slider">
            <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
            <Setter Property="Background" Value="{StaticResource PanelBrush}"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Margin" Value="0,2"/>
        </Style>

        <!-- Vertical Slider Style for Harmonics -->
        <Style x:Key="HarmonicSliderStyle" TargetType="Slider">
            <Setter Property="Orientation" Value="Vertical"/>
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="1"/>
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Margin" Value="1,0"/>
            <Setter Property="VerticalAlignment" Value="Bottom"/>
        </Style>

        <!-- Drawbar Slider Style -->
        <Style x:Key="DrawbarSliderStyle" TargetType="Slider">
            <Setter Property="Orientation" Value="Vertical"/>
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="8"/>
            <Setter Property="IsSnapToTickEnabled" Value="True"/>
            <Setter Property="TickFrequency" Value="1"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="150"/>
            <Setter Property="Margin" Value="4,0"/>
        </Style>

        <!-- Label Style -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextDimBrush}"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Value Label Style -->
        <Style x:Key="ValueStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="MinWidth" Value="40"/>
        </Style>

        <!-- Header Style -->
        <Style x:Key="HeaderStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>

        <!-- Button Style -->
        <Style x:Key="DarkButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PanelBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource PanelLightBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BackgroundBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Preset Button Style -->
        <Style x:Key="PresetButtonStyle" TargetType="Button" BasedOn="{StaticResource DarkButtonStyle}">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="MinWidth" Value="60"/>
        </Style>

        <!-- Toggle Button Style -->
        <Style x:Key="ToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="{StaticResource PanelBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PanelLightBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource AccentBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BackgroundBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Panel Border Style -->
        <Style x:Key="PanelStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource PanelBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="4"/>
        </Style>

        <!-- Harmonic Bar Template -->
        <DataTemplate x:Key="HarmonicBarTemplate" DataType="{x:Type vm:HarmonicSliderViewModel}">
            <Grid Width="18" Margin="1,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Harmonic Slider -->
                <Slider Grid.Row="0"
                        Style="{StaticResource HarmonicSliderStyle}"
                        Value="{Binding Amplitude, Mode=TwoWay}"
                        ToolTip="{Binding Amplitude, StringFormat='Harmonic {0}: {1:F2}'}"
                        Tag="{Binding}"/>

                <!-- Harmonic Number -->
                <TextBlock Grid.Row="1"
                           Text="{Binding Label}"
                           Foreground="{StaticResource TextDimBrush}"
                           FontSize="8"
                           HorizontalAlignment="Center"
                           Margin="0,2,0,0"/>
            </Grid>
        </DataTemplate>

        <!-- Drawbar Template -->
        <DataTemplate x:Key="DrawbarTemplate" DataType="{x:Type vm:DrawbarViewModel}">
            <StackPanel Margin="4,0">
                <!-- Drawbar Value Display -->
                <TextBlock Text="{Binding Value}"
                           Foreground="{StaticResource ForegroundBrush}"
                           FontSize="14"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,4"/>

                <!-- Drawbar Slider -->
                <Border Background="{Binding ColorHex, Converter={x:Static local:AdditiveSynthControl.ColorToBrushConverter}}"
                        CornerRadius="4"
                        Padding="4">
                    <Slider Style="{StaticResource DrawbarSliderStyle}"
                            Value="{Binding Value, Mode=TwoWay}"
                            IsDirectionReversed="True"
                            ToolTip="{Binding Footage}"/>
                </Border>

                <!-- Footage Label -->
                <TextBlock Text="{Binding Footage}"
                           Foreground="{StaticResource TextDimBrush}"
                           FontSize="9"
                           HorizontalAlignment="Center"
                           Margin="0,4,0,0"/>
            </StackPanel>
        </DataTemplate>

    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Bar -->
        <Border Grid.Row="0" Style="{StaticResource PanelStyle}" Margin="4,4,4,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title and Mode Toggle -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="ADDITIVE SYNTH" Style="{StaticResource HeaderStyle}"
                               Foreground="{StaticResource AccentBrush}" FontSize="16" Margin="0,0,20,0"/>
                    <TextBlock Text="{Binding CurrentPresetName}" Style="{StaticResource ValueStyle}"
                               FontSize="14" Margin="0,0,20,0"/>
                    <ToggleButton Content="Drawbar Mode"
                                  Style="{StaticResource ToggleButtonStyle}"
                                  IsChecked="{Binding IsDrawbarMode}"
                                  Margin="0,0,8,0"/>
                    <Button Content="Reset" Style="{StaticResource DarkButtonStyle}"
                            Command="{Binding ResetAllCommand}" Margin="0,0,8,0"/>
                    <Button Content="Random" Style="{StaticResource DarkButtonStyle}"
                            Command="{Binding RandomizeHarmonicsCommand}" Margin="0,0,8,0"/>
                    <Button Content="Normalize" Style="{StaticResource DarkButtonStyle}"
                            Command="{Binding NormalizeHarmonicsCommand}"/>
                </StackPanel>

                <!-- Harmonic Count Selector -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="Harmonics:" Style="{StaticResource LabelStyle}"
                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <Button Content="16" Style="{StaticResource PresetButtonStyle}"
                            Command="{Binding SetHarmonicCountCommand}" CommandParameter="16"/>
                    <Button Content="32" Style="{StaticResource PresetButtonStyle}"
                            Command="{Binding SetHarmonicCountCommand}" CommandParameter="32"/>
                    <Button Content="64" Style="{StaticResource PresetButtonStyle}"
                            Command="{Binding SetHarmonicCountCommand}" CommandParameter="64"/>
                </StackPanel>

                <!-- Master Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Volume:" Style="{StaticResource LabelStyle}" Margin="0,0,8,0"/>
                    <Slider Value="{Binding MasterVolume}" Minimum="0" Maximum="1" Width="100"
                            Style="{StaticResource DarkSliderStyle}"/>
                    <TextBlock Text="{Binding MasterVolume, StringFormat='{}{0:F2}'}"
                               Style="{StaticResource ValueStyle}" Width="40" Margin="8,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="280"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Harmonics/Drawbars and Waveform -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="200"/>
                </Grid.RowDefinitions>

                <!-- Harmonics/Drawbars Panel -->
                <Border Grid.Row="0" Style="{StaticResource PanelStyle}">
                    <Grid>
                        <!-- Harmonic Bars View (visible when not in Drawbar mode) -->
                        <Grid Visibility="{Binding IsDrawbarMode, Converter={x:Static local:AdditiveSynthControl.InverseBoolToVisibilityConverter}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="HARMONIC BARS (64 Harmonics)" Style="{StaticResource HeaderStyle}"/>

                            <!-- Harmonic Balance Controls -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="Even/Odd Balance:" Style="{StaticResource LabelStyle}" Margin="0,0,8,0"/>
                                <Slider x:Name="EvenOddBalanceSlider"
                                        Minimum="-1" Maximum="1" Value="0" Width="150"
                                        Style="{StaticResource DarkSliderStyle}"
                                        ValueChanged="EvenOddBalanceSlider_ValueChanged"
                                        ToolTip="Negative = Odd harmonics, Positive = Even harmonics"/>
                                <TextBlock Text="Odd" Style="{StaticResource LabelStyle}" Foreground="{StaticResource OddHarmonicBrush}" Margin="8,0,4,0"/>
                                <TextBlock Text="|" Style="{StaticResource LabelStyle}" Margin="0,0,4,0"/>
                                <TextBlock Text="Even" Style="{StaticResource LabelStyle}" Foreground="{StaticResource EvenHarmonicBrush}"/>
                            </StackPanel>

                            <!-- Harmonic Sliders -->
                            <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                                <ItemsControl ItemsSource="{Binding Harmonics}"
                                              ItemTemplate="{StaticResource HarmonicBarTemplate}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>

                        <!-- Drawbar View (visible when in Drawbar mode) -->
                        <Grid Visibility="{Binding IsDrawbarMode, Converter={x:Static local:AdditiveSynthControl.BoolToVisibilityConverter}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="HAMMOND DRAWBARS (9 Drawbars)" Style="{StaticResource HeaderStyle}"/>

                            <!-- Drawbar Preset Buttons -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="Presets:" Style="{StaticResource LabelStyle}" Margin="0,0,8,0"/>
                                <Button Content="888000000" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="888000000"
                                        ToolTip="Full Organ"/>
                                <Button Content="888888888" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="888888888"
                                        ToolTip="All Drawbars Full"/>
                                <Button Content="800000008" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="800000008"
                                        ToolTip="Fundamental + Octave"/>
                                <Button Content="006050400" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="006050400"
                                        ToolTip="Flute"/>
                                <Button Content="838000000" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="838000000"
                                        ToolTip="Tibia"/>
                                <Button Content="688800000" Style="{StaticResource PresetButtonStyle}"
                                        Command="{Binding ApplyDrawbarPresetCommand}" CommandParameter="688800000"
                                        ToolTip="Strings"/>
                            </StackPanel>

                            <!-- 9 Drawbars -->
                            <Border Grid.Row="2" Background="{StaticResource PanelLightBrush}" CornerRadius="4" Padding="16">
                                <ItemsControl ItemsSource="{Binding Drawbars}"
                                              ItemTemplate="{StaticResource DrawbarTemplate}"
                                              HorizontalAlignment="Center">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Waveform Preview Panel -->
                <Border Grid.Row="1" Style="{StaticResource PanelStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="WAVEFORM PREVIEW" Style="{StaticResource HeaderStyle}"/>

                        <Border Grid.Row="1" Background="#101010" BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="1" CornerRadius="4">
                            <Canvas x:Name="WaveformCanvas" ClipToBounds="True" SizeChanged="WaveformCanvas_SizeChanged"/>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- Right Panel: Presets, Envelope, and Selected Harmonic -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Harmonic Presets -->
                <Border Grid.Row="0" Style="{StaticResource PanelStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="HARMONIC PRESETS" Style="{StaticResource HeaderStyle}"/>

                        <ItemsControl Grid.Row="1" ItemsSource="{Binding Presets}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:HarmonicPresetViewModel}">
                                    <Button Style="{StaticResource PresetButtonStyle}"
                                            Content="{Binding Name}"
                                            ToolTip="{Binding Description}"
                                            Command="{Binding DataContext.ApplyPresetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>

                <!-- Global Envelope -->
                <Border Grid.Row="1" Style="{StaticResource PanelStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="AMPLITUDE ENVELOPE" Style="{StaticResource HeaderStyle}"/>

                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Attack -->
                            <StackPanel Grid.Column="0" Margin="4">
                                <TextBlock Text="Attack" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                <Slider Value="{Binding Attack}" Minimum="0.001" Maximum="2"
                                        Orientation="Vertical" Height="80" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Attack, StringFormat='{}{0:F2}s'}"
                                           Style="{StaticResource ValueStyle}" HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Decay -->
                            <StackPanel Grid.Column="1" Margin="4">
                                <TextBlock Text="Decay" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                <Slider Value="{Binding Decay}" Minimum="0.001" Maximum="2"
                                        Orientation="Vertical" Height="80" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Decay, StringFormat='{}{0:F2}s'}"
                                           Style="{StaticResource ValueStyle}" HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Sustain -->
                            <StackPanel Grid.Column="2" Margin="4">
                                <TextBlock Text="Sustain" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                <Slider Value="{Binding Sustain}" Minimum="0" Maximum="1"
                                        Orientation="Vertical" Height="80" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Sustain, StringFormat='{}{0:F2}'}"
                                           Style="{StaticResource ValueStyle}" HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Release -->
                            <StackPanel Grid.Column="3" Margin="4">
                                <TextBlock Text="Release" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                <Slider Value="{Binding Release}" Minimum="0.001" Maximum="4"
                                        Orientation="Vertical" Height="80" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Release, StringFormat='{}{0:F2}s'}"
                                           Style="{StaticResource ValueStyle}" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Selected Harmonic Details -->
                <Border Grid.Row="2" Style="{StaticResource PanelStyle}">
                    <Grid DataContext="{Binding SelectedHarmonic}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal">
                            <TextBlock Text="SELECTED HARMONIC: " Style="{StaticResource HeaderStyle}"/>
                            <TextBlock Text="{Binding HarmonicNumber, FallbackValue='-'}"
                                       Foreground="{StaticResource AccentBrush}"
                                       FontWeight="Bold" FontSize="12"/>
                        </StackPanel>

                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <StackPanel Visibility="{Binding Converter={x:Static local:AdditiveSynthControl.NullToVisibilityConverter}}">

                                <!-- Amplitude -->
                                <StackPanel Margin="0,0,0,12">
                                    <Grid>
                                        <TextBlock Text="Amplitude" Style="{StaticResource LabelStyle}"/>
                                        <TextBlock Text="{Binding Amplitude, StringFormat='{}{0:F2}'}"
                                                   Style="{StaticResource ValueStyle}"/>
                                    </Grid>
                                    <Slider Value="{Binding Amplitude}" Minimum="0" Maximum="1"
                                            Style="{StaticResource DarkSliderStyle}"/>
                                </StackPanel>

                                <!-- Phase -->
                                <StackPanel Margin="0,0,0,12">
                                    <Grid>
                                        <TextBlock Text="Phase" Style="{StaticResource LabelStyle}"/>
                                        <TextBlock Text="{Binding Phase, StringFormat='{}{0:F2}'}"
                                                   Style="{StaticResource ValueStyle}"/>
                                    </Grid>
                                    <Slider Value="{Binding Phase}" Minimum="0" Maximum="1"
                                            Style="{StaticResource DarkSliderStyle}"/>
                                </StackPanel>

                                <!-- Detune -->
                                <StackPanel Margin="0,0,0,12">
                                    <Grid>
                                        <TextBlock Text="Detune (cents)" Style="{StaticResource LabelStyle}"/>
                                        <TextBlock Text="{Binding Detune, StringFormat='{}{0:F0}c'}"
                                                   Style="{StaticResource ValueStyle}"/>
                                    </Grid>
                                    <Slider Value="{Binding Detune}" Minimum="-100" Maximum="100"
                                            Style="{StaticResource DarkSliderStyle}"/>
                                </StackPanel>

                                <!-- Per-Harmonic Envelope Toggle -->
                                <StackPanel Margin="0,0,0,12">
                                    <CheckBox Content="Custom Envelope" IsChecked="{Binding HasCustomEnvelope}"
                                              Foreground="{StaticResource ForegroundBrush}"/>
                                </StackPanel>

                                <!-- Per-Harmonic Envelope (visible when enabled) -->
                                <Border Background="{StaticResource PanelLightBrush}" CornerRadius="4" Padding="8"
                                        Visibility="{Binding HasCustomEnvelope, Converter={x:Static local:AdditiveSynthControl.BoolToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="Harmonic Envelope" Style="{StaticResource LabelStyle}"
                                                   FontWeight="SemiBold" Margin="0,0,0,8"/>

                                        <!-- Per-Harmonic ADSR -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <StackPanel Grid.Row="0" Grid.Column="0" Margin="2">
                                                <TextBlock Text="A" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                                <Slider Value="{Binding Attack}" Minimum="0.001" Maximum="2"
                                                        Style="{StaticResource DarkSliderStyle}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Row="0" Grid.Column="1" Margin="2">
                                                <TextBlock Text="D" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                                <Slider Value="{Binding Decay}" Minimum="0.001" Maximum="2"
                                                        Style="{StaticResource DarkSliderStyle}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Row="1" Grid.Column="0" Margin="2">
                                                <TextBlock Text="S" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                                <Slider Value="{Binding Sustain}" Minimum="0" Maximum="1"
                                                        Style="{StaticResource DarkSliderStyle}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Row="1" Grid.Column="1" Margin="2">
                                                <TextBlock Text="R" Style="{StaticResource LabelStyle}" HorizontalAlignment="Center"/>
                                                <Slider Value="{Binding Release}" Minimum="0.001" Maximum="4"
                                                        Style="{StaticResource DarkSliderStyle}"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <!-- No Selection Message -->
                        <TextBlock Grid.Row="1"
                                   Text="Click a harmonic slider to select it"
                                   Style="{StaticResource LabelStyle}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Visibility="{Binding Converter={x:Static local:AdditiveSynthControl.NullToCollapsedConverter}}"/>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" Style="{StaticResource PanelStyle}" Margin="4,0,4,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}"
                           Style="{StaticResource LabelStyle}"/>

                <!-- Preview Button -->
                <Button Grid.Column="1" Content="Preview (C4)"
                        Style="{StaticResource DarkButtonStyle}"
                        Command="{Binding PlayPreviewNoteCommand}"
                        CommandParameter="60"
                        Margin="0,0,16,0"/>

                <!-- Mode Indicator -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Mode: " Style="{StaticResource LabelStyle}"/>
                    <TextBlock Text="{Binding IsDrawbarMode, Converter={x:Static local:AdditiveSynthControl.ModeTextConverter}}"
                               Foreground="{StaticResource SuccessBrush}" FontWeight="SemiBold"/>
                    <TextBlock Text=" | Harmonics: " Style="{StaticResource LabelStyle}" Margin="16,0,0,0"/>
                    <TextBlock Text="{Binding HarmonicCount}"
                               Foreground="{StaticResource AccentBrush}" FontWeight="SemiBold"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
