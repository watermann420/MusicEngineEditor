<UserControl x:Class="MusicEngineEditor.Controls.EffectSlotControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="24" d:DesignWidth="200"
             MinHeight="22"
             MaxHeight="28">

    <UserControl.Resources>
        <!-- Colors -->
        <Color x:Key="SlotBackgroundColor">#2D2E32</Color>
        <Color x:Key="SlotBorderColor">#3C3F44</Color>
        <Color x:Key="SlotHoverColor">#3A3B40</Color>
        <Color x:Key="TextPrimaryColor">#BCBEC4</Color>
        <Color x:Key="TextSecondaryColor">#6F737A</Color>
        <Color x:Key="EmptyTextColor">#505358</Color>
        <Color x:Key="BypassedColor">#FF5555</Color>
        <Color x:Key="ButtonHoverColor">#4A4D52</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="SlotBackgroundBrush" Color="{StaticResource SlotBackgroundColor}"/>
        <SolidColorBrush x:Key="SlotBorderBrush" Color="{StaticResource SlotBorderColor}"/>
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="{StaticResource TextPrimaryColor}"/>
        <SolidColorBrush x:Key="TextSecondaryBrush" Color="{StaticResource TextSecondaryColor}"/>
        <SolidColorBrush x:Key="EmptyTextBrush" Color="{StaticResource EmptyTextColor}"/>
        <SolidColorBrush x:Key="BypassedBrush" Color="{StaticResource BypassedColor}"/>

        <!-- Small Button Style -->
        <Style x:Key="SlotButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                CornerRadius="2"
                                Padding="2">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#4A4D52"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#5A5D62"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Bypass Toggle Button Style -->
        <Style x:Key="BypassToggleStyle" TargetType="ToggleButton">
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="FontSize" Value="9"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                CornerRadius="2"
                                Padding="2">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#4A4D52"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#FF5555"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
    </UserControl.Resources>

    <Border x:Name="SlotBorder"
            Background="{StaticResource SlotBackgroundBrush}"
            BorderBrush="{StaticResource SlotBorderBrush}"
            BorderThickness="1"
            CornerRadius="2"
            Padding="2"
            Cursor="Hand"
            MouseLeftButtonDown="SlotBorder_MouseLeftButtonDown"
            MouseEnter="SlotBorder_MouseEnter"
            MouseLeave="SlotBorder_MouseLeave">
        <Border.ContextMenu>
            <ContextMenu>
                <MenuItem Header="Remove Effect" Click="RemoveEffect_Click"
                          IsEnabled="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}"/>
                <MenuItem Header="Bypass" Click="Bypass_Click" IsCheckable="True"
                          IsChecked="{Binding IsBypassed}"
                          IsEnabled="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}"/>
                <Separator/>
                <MenuItem Header="Move Up" Click="MoveUp_Click"
                          IsEnabled="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}"/>
                <MenuItem Header="Move Down" Click="MoveDown_Click"
                          IsEnabled="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}"/>
                <Separator/>
                <MenuItem Header="Edit Effect" Click="EditEffect_Click"
                          IsEnabled="{Binding IsEmpty, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}"/>
            </ContextMenu>
        </Border.ContextMenu>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="4"/>      <!-- Color indicator -->
                <ColumnDefinition Width="*"/>      <!-- Effect name -->
                <ColumnDefinition Width="Auto"/>   <!-- Type badge -->
                <ColumnDefinition Width="Auto"/>   <!-- Bypass button -->
                <ColumnDefinition Width="Auto"/>   <!-- Edit button -->
            </Grid.ColumnDefinitions>

            <!-- Color Indicator -->
            <Border Grid.Column="0"
                    Width="4"
                    CornerRadius="1"
                    Margin="0,1,3,1">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="{Binding EffectColor, FallbackValue=#6B7280}"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsEmpty}" Value="True">
                                <Setter Property="Background" Value="#3C3F44"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
            </Border>

            <!-- Effect Name -->
            <TextBlock Grid.Column="1"
                       VerticalAlignment="Center"
                       Margin="2,0"
                       FontSize="10"
                       TextTrimming="CharacterEllipsis">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Text" Value="{Binding DisplayName, FallbackValue=Empty}"/>
                        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                        <Setter Property="FontStyle" Value="Normal"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsEmpty}" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource EmptyTextBrush}"/>
                                <Setter Property="FontStyle" Value="Italic"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsBypassed}" Value="True">
                                <Setter Property="TextDecorations" Value="Strikethrough"/>
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- Type Badge (VST2/VST3/INT) -->
            <Border Grid.Column="2"
                    CornerRadius="2"
                    Padding="3,1"
                    Margin="2,0"
                    VerticalAlignment="Center"
                    Visibility="{Binding IsEmpty, Converter={StaticResource InverseBoolToVisConverter}, FallbackValue=Visible}">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="#3C3F44"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsVstEffect}" Value="True">
                                <Setter Property="Background" Value="#5B4B8A"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <TextBlock Text="{Binding TypeBadge, FallbackValue=INT}"
                           FontSize="8"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource TextSecondaryBrush}"/>
            </Border>

            <!-- Bypass Button -->
            <ToggleButton Grid.Column="3"
                          Style="{StaticResource BypassToggleStyle}"
                          Content="B"
                          ToolTip="Bypass Effect"
                          IsChecked="{Binding IsBypassed, Mode=TwoWay}"
                          Visibility="{Binding IsEmpty, Converter={StaticResource InverseBoolToVisConverter}, FallbackValue=Visible}"
                          Margin="1,0"/>

            <!-- Edit Button (or Add button when empty) -->
            <Button Grid.Column="4"
                    Style="{StaticResource SlotButtonStyle}"
                    ToolTip="{Binding IsEmpty, Converter={StaticResource EmptyToAddTooltipConverter}, FallbackValue=Edit Effect}"
                    Click="EditOrAdd_Click"
                    Margin="1,0">
                <Button.Content>
                    <TextBlock>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="E"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsEmpty}" Value="True">
                                        <Setter Property="Text" Value="+"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Button.Content>
            </Button>
        </Grid>
    </Border>
</UserControl>
