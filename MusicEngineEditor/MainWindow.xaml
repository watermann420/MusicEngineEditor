<Window x:Class="MusicEngineEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:avalonDock="https://github.com/Dirkster99/AvalonDock"
        xmlns:views="clr-namespace:MusicEngineEditor.Views"
        Title="MusicEngine Editor"
        Height="800" Width="1200"
        MinHeight="500" MinWidth="800"
        Style="{StaticResource DarkWindowStyle}"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized">

    <Window.InputBindings>
        <KeyBinding Key="F5" Command="{Binding RunCommand}"/>
        <KeyBinding Key="F5" Modifiers="Shift" Command="{Binding StopCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveAllCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl+Shift" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl+Shift" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewFileCommand}"/>
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding FindCommand}"/>
        <KeyBinding Key="H" Modifiers="Ctrl" Command="{Binding ReplaceCommand}"/>
        <KeyBinding Key="Escape" Command="{Binding StopCommand}"/>
    </Window.InputBindings>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top" Background="{StaticResource MenuBackgroundBrush}">
            <MenuItem Header="_File">
                <MenuItem Header="_New Project..." InputGestureText="Ctrl+Shift+N" Click="NewProject_Click"/>
                <MenuItem Header="_Open Project..." InputGestureText="Ctrl+Shift+O" Click="OpenProject_Click"/>
                <Separator/>
                <MenuItem Header="New _File..." InputGestureText="Ctrl+N" Click="NewFile_Click"/>
                <MenuItem Header="_Save" InputGestureText="Ctrl+S" Click="SaveScript_Click"/>
                <MenuItem Header="Save _All" InputGestureText="Ctrl+Shift+S" Click="SaveAll_Click"/>
                <Separator/>
                <MenuItem Header="Recent Projects" x:Name="RecentProjectsMenu"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" Command="Undo" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="_Redo" Command="Redo" InputGestureText="Ctrl+Y"/>
                <Separator/>
                <MenuItem Header="Cu_t" Command="Cut" InputGestureText="Ctrl+X"/>
                <MenuItem Header="_Copy" Command="Copy" InputGestureText="Ctrl+C"/>
                <MenuItem Header="_Paste" Command="Paste" InputGestureText="Ctrl+V"/>
                <Separator/>
                <MenuItem Header="_Find..." InputGestureText="Ctrl+F" Click="Find_Click"/>
                <MenuItem Header="Find and _Replace..." InputGestureText="Ctrl+H" Click="Replace_Click"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="Project Explorer" IsCheckable="True" IsChecked="True" x:Name="ProjectExplorerMenuItem"/>
                <MenuItem Header="Output" IsCheckable="True" IsChecked="True" x:Name="OutputMenuItem"/>
            </MenuItem>
            <MenuItem Header="_Project">
                <MenuItem Header="_Add New Script..." Click="AddScript_Click"/>
                <MenuItem Header="Import _Audio..." Click="ImportAudio_Click"/>
                <Separator/>
                <MenuItem Header="Add Project _Reference..." Click="AddReference_Click"/>
                <Separator/>
                <MenuItem Header="Project _Settings..." Click="ProjectSettings_Click"/>
            </MenuItem>
            <MenuItem Header="_Run">
                <MenuItem Header="_Run" InputGestureText="F5" Click="RunScript_Click"/>
                <MenuItem Header="_Stop" InputGestureText="Shift+F5" Click="Stop_Click"/>
                <Separator/>
                <MenuItem Header="All Notes _Off" InputGestureText="Esc" Click="Panic_Click"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Documentation" Click="Documentation_Click"/>
                <MenuItem Header="_About" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Background="{StaticResource ToolbarBackgroundBrush}" Padding="4">
            <DockPanel>
                <!-- Left: File & Run Buttons -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Button Content="New Project" Style="{StaticResource ToolbarButtonStyle}" Click="NewProject_Click" ToolTip="New Project (Ctrl+Shift+N)"/>
                    <Button Content="Open" Style="{StaticResource ToolbarButtonStyle}" Click="OpenProject_Click" ToolTip="Open Project (Ctrl+Shift+O)" Margin="4,0,0,0"/>
                    <Button Content="Save All" Style="{StaticResource ToolbarButtonStyle}" Click="SaveAll_Click" ToolTip="Save All (Ctrl+Shift+S)" Margin="4,0,0,0"/>

                    <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="12,2"/>

                    <Button x:Name="RunButton" Content="Run (F5)" Style="{StaticResource RunButtonStyle}" Click="RunScript_Click" ToolTip="Execute Script (F5)"/>
                    <Button Content="Stop" Style="{StaticResource ToolbarButtonStyle}" Click="Stop_Click" ToolTip="Stop (Shift+F5)" Margin="4,0,0,0"/>
                    <Button Content="Panic" Style="{StaticResource ToolbarButtonStyle}" Click="Panic_Click" ToolTip="All Notes Off (Esc)" Margin="4,0,0,0"/>
                </StackPanel>

                <!-- Right: Status Display -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                    <TextBlock Text="BPM:" Foreground="{StaticResource SecondaryForegroundBrush}" VerticalAlignment="Center"/>
                    <TextBox x:Name="BpmBox" Text="120" Width="50" Margin="4,0,16,0"
                             Background="{StaticResource EditorBackgroundBrush}"
                             Foreground="{StaticResource ForegroundBrush}"
                             BorderBrush="{StaticResource BorderBrush}"
                             VerticalAlignment="Center"
                             TextAlignment="Center"
                             KeyDown="BpmBox_KeyDown"/>

                    <TextBlock Text="Beat:" Foreground="{StaticResource SecondaryForegroundBrush}" VerticalAlignment="Center"/>
                    <TextBlock x:Name="BeatDisplay" Text="0.00" Foreground="{StaticResource ForegroundBrush}" Margin="4,0,16,0" FontWeight="Bold" Width="50" VerticalAlignment="Center"/>

                    <TextBlock Text="Patterns:" Foreground="{StaticResource SecondaryForegroundBrush}" VerticalAlignment="Center"/>
                    <TextBlock x:Name="PatternCountDisplay" Text="0" Foreground="{StaticResource ForegroundBrush}" Margin="4,0,0,0" FontWeight="Bold" VerticalAlignment="Center"/>
                </StackPanel>

                <Border/> <!-- Spacer -->
            </DockPanel>
        </Border>

        <!-- Status Bar -->
        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock x:Name="StatusText" Text="Ready"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="ProjectNameDisplay" Text="No project loaded"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="FileNameDisplay" Text=""/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="CaretPositionDisplay" Text="Ln 1, Col 1" Margin="0,0,16,0"/>
                    <TextBlock Text="UTF-8"/>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <!-- Main Content: 3-Column Layout -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" MinWidth="150" x:Name="LeftPanelColumn"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="0" MinWidth="0" x:Name="RightPanelColumn"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Project Explorer -->
            <Border Grid.Column="0" Background="{StaticResource PanelBackgroundBrush}" x:Name="ProjectExplorerPanel">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="#252526" Padding="8,4">
                        <TextBlock Text="PROJECT EXPLORER" FontWeight="SemiBold" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                    </Border>
                    <TreeView x:Name="ProjectTree"
                              Background="Transparent"
                              BorderThickness="0"
                              Padding="4"
                              MouseDoubleClick="ProjectTree_MouseDoubleClick">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem">
                                <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                <Setter Property="IsExpanded" Value="True"/>
                            </Style>
                        </TreeView.ItemContainerStyle>
                    </TreeView>
                </DockPanel>
            </Border>

            <!-- Left Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" ResizeDirection="Columns"/>

            <!-- Center: Editor + Output -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="3*" MinHeight="100"/>
                    <RowDefinition Height="5"/>
                    <RowDefinition Height="*" MinHeight="80"/>
                </Grid.RowDefinitions>

                <!-- Code Editor with Tabs -->
                <Border Grid.Row="0" Background="{StaticResource EditorBackgroundBrush}">
                    <DockPanel>
                        <!-- Tab Bar -->
                        <Border DockPanel.Dock="Top" Background="#252526">
                            <TabControl x:Name="EditorTabs"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        SelectionChanged="EditorTabs_SelectionChanged">
                                <TabControl.ItemContainerStyle>
                                    <Style TargetType="TabItem">
                                        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Padding" Value="12,6"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TabItem">
                                                    <Border x:Name="Border"
                                                            Background="{TemplateBinding Background}"
                                                            BorderThickness="0,0,0,2"
                                                            BorderBrush="Transparent"
                                                            Padding="{TemplateBinding Padding}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <ContentPresenter ContentSource="Header"/>
                                                            <Button Content="x" Margin="8,0,0,0"
                                                                    Background="Transparent"
                                                                    BorderThickness="0"
                                                                    Foreground="{StaticResource SecondaryForegroundBrush}"
                                                                    Padding="4,0"
                                                                    Click="CloseTab_Click"
                                                                    Tag="{Binding RelativeSource={RelativeSource TemplatedParent}}"/>
                                                        </StackPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="{StaticResource EditorBackgroundBrush}"/>
                                                            <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                        </Trigger>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="#3E3E42"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TabControl.ItemContainerStyle>
                            </TabControl>
                        </Border>

                        <!-- Editor Area -->
                        <avalonedit:TextEditor
                            x:Name="CodeEditor"
                            FontFamily="JetBrains Mono, Consolas, Courier New"
                            FontSize="14"
                            ShowLineNumbers="True"
                            Background="{StaticResource EditorBackgroundBrush}"
                            Foreground="{StaticResource ForegroundBrush}"
                            LineNumbersForeground="{StaticResource SecondaryForegroundBrush}"
                            Padding="4"
                            VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto"/>
                    </DockPanel>
                </Border>

                <!-- Splitter -->
                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" ResizeDirection="Rows"/>

                <!-- Output Panel -->
                <Border Grid.Row="2" Background="{StaticResource PanelBackgroundBrush}" x:Name="OutputPanel">
                    <DockPanel>
                        <!-- Output Header with Tabs -->
                        <Border DockPanel.Dock="Top" Background="#252526" Padding="0">
                            <DockPanel>
                                <Button Content="Clear" Style="{StaticResource ToolbarButtonStyle}" Click="ClearOutput_Click" DockPanel.Dock="Right" FontSize="11" Padding="8,4" Margin="4"/>
                                <TabControl Background="Transparent" BorderThickness="0">
                                    <TabControl.ItemContainerStyle>
                                        <Style TargetType="TabItem">
                                            <Setter Property="Foreground" Value="{StaticResource SecondaryForegroundBrush}"/>
                                            <Setter Property="Padding" Value="8,4"/>
                                        </Style>
                                    </TabControl.ItemContainerStyle>
                                    <TabItem Header="OUTPUT" IsSelected="True"/>
                                    <TabItem Header="ERRORS"/>
                                </TabControl>
                            </DockPanel>
                        </Border>

                        <!-- Output Content -->
                        <TextBox x:Name="OutputBox"
                                 Style="{StaticResource OutputTextBoxStyle}"
                                 TextWrapping="NoWrap"
                                 AcceptsReturn="True"/>
                    </DockPanel>
                </Border>
            </Grid>

            <!-- Right Splitter (hidden by default) -->
            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Stretch" ResizeDirection="Columns" Visibility="Collapsed"/>

            <!-- Right Panel (Properties - hidden by default) -->
            <Border Grid.Column="4" Background="{StaticResource PanelBackgroundBrush}" Visibility="Collapsed" x:Name="PropertiesPanel">
                <DockPanel>
                    <Border DockPanel.Dock="Top" Background="#252526" Padding="8,4">
                        <TextBlock Text="PROPERTIES" FontWeight="SemiBold" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                    </Border>
                    <TextBlock Text="No item selected" Foreground="{StaticResource SecondaryForegroundBrush}" Padding="8"/>
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
