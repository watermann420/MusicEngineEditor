<Window x:Class="MusicEngineEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:avalonDock="https://github.com/Dirkster99/AvalonDock"
        xmlns:views="clr-namespace:MusicEngineEditor.Views"
        xmlns:controls="clr-namespace:MusicEngineEditor.Controls"
        Title="MusicEngine Editor"
        Height="800" Width="1200"
        MinHeight="500" MinWidth="800"
        Style="{StaticResource DarkWindowStyle}"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        WindowStyle="None"
        AllowsTransparency="False"
        ResizeMode="CanResizeWithGrip"
        Background="#1E1F22">

    <Window.InputBindings>
        <!-- Run with Ctrl+Enter or F5 -->
        <KeyBinding Key="Enter" Modifiers="Ctrl" Command="{Binding RunCommand}"/>
        <KeyBinding Key="F5" Command="{Binding RunCommand}"/>
        <!-- Stop with Escape -->
        <KeyBinding Key="Escape" Command="{Binding StopCommand}"/>
        <KeyBinding Key="F5" Modifiers="Shift" Command="{Binding StopCommand}"/>
        <!-- File operations -->
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveAllCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl+Shift" Command="{Binding OpenProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl+Shift" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewFileCommand}"/>
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding FindCommand}"/>
        <KeyBinding Key="H" Modifiers="Ctrl" Command="{Binding ReplaceCommand}"/>
        <KeyBinding Key="OemComma" Modifiers="Ctrl" Command="{Binding OpenSettingsCommand}"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Custom Title Bar with Menu and Window Controls -->
        <Border Grid.Row="0" Background="#1E1F22" BorderBrush="#393B40" BorderThickness="0,0,0,1"
                MouseLeftButtonDown="TitleBar_MouseLeftButtonDown"
                MouseLeftButtonUp="TitleBar_MouseLeftButtonUp"
                MouseMove="TitleBar_MouseMove">
            <Grid Height="32">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: App Icon + Menu -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- App Icon -->
                    <Border Margin="8,0,4,0" VerticalAlignment="Center">
                        <TextBlock Text="&#x266B;" FontSize="16" Foreground="#4B6EAF" FontWeight="Bold" VerticalAlignment="Center"/>
                    </Border>

                    <!-- Menu Bar (integrated into title bar) -->
                    <Menu Background="Transparent" VerticalAlignment="Center">
                        <Menu.Resources>
                            <Style TargetType="MenuItem">
                                <Setter Property="Foreground" Value="#BCBEC4"/>
                                <Setter Property="Padding" Value="8,6"/>
                                <Setter Property="FontSize" Value="12"/>
                                <Style.Triggers>
                                    <Trigger Property="IsHighlighted" Value="True">
                                        <Setter Property="Background" Value="#3C3F41"/>
                                    </Trigger>
                                    <Trigger Property="IsSubmenuOpen" Value="True">
                                        <Setter Property="Background" Value="#3C3F41"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Menu.Resources>
                        <MenuItem Header="File">
                            <MenuItem Header="_New Project..." InputGestureText="Ctrl+Shift+N" Click="NewProject_Click"/>
                            <MenuItem Header="_Open Project..." InputGestureText="Ctrl+Shift+O" Click="OpenProject_Click"/>
                            <Separator/>
                            <MenuItem Header="New _File..." InputGestureText="Ctrl+N" Click="NewFile_Click"/>
                            <MenuItem Header="_Save" InputGestureText="Ctrl+S" Click="SaveScript_Click"/>
                            <MenuItem Header="Save _All" InputGestureText="Ctrl+Shift+S" Click="SaveAll_Click"/>
                            <Separator/>
                            <MenuItem Header="Recent Projects" x:Name="RecentProjectsMenu"/>
                            <Separator/>
                            <MenuItem Header="_Settings..." InputGestureText="Ctrl+," Click="Settings_Click"/>
                            <Separator/>
                            <MenuItem Header="E_xit" Click="Exit_Click"/>
                        </MenuItem>
                        <MenuItem Header="Edit">
                            <MenuItem Header="_Undo" Command="Undo" InputGestureText="Ctrl+Z"/>
                            <MenuItem Header="_Redo" Command="Redo" InputGestureText="Ctrl+Y"/>
                            <Separator/>
                            <MenuItem Header="Cu_t" Command="Cut" InputGestureText="Ctrl+X"/>
                            <MenuItem Header="_Copy" Command="Copy" InputGestureText="Ctrl+C"/>
                            <MenuItem Header="_Paste" Command="Paste" InputGestureText="Ctrl+V"/>
                            <Separator/>
                            <MenuItem Header="_Find..." InputGestureText="Ctrl+F" Click="Find_Click"/>
                            <MenuItem Header="Find and _Replace..." InputGestureText="Ctrl+H" Click="Replace_Click"/>
                        </MenuItem>
                        <MenuItem Header="View">
                            <MenuItem Header="Project Explorer" IsCheckable="True" IsChecked="True" x:Name="ProjectExplorerMenuItem" Click="ToggleProjectExplorer_Click"/>
                            <MenuItem Header="Workshop" IsCheckable="True" IsChecked="False" x:Name="WorkshopMenuItem" Click="ToggleWorkshop_Click"/>
                            <MenuItem Header="Output" IsCheckable="True" IsChecked="True" x:Name="OutputMenuItem" Click="ToggleOutput_Click"/>
                            <Separator/>
                            <MenuItem Header="MIDI Devices" IsCheckable="True" IsChecked="False" x:Name="MidiPanelMenuItem" Click="ToggleMidiPanel_Click"/>
                            <MenuItem Header="VST Plugins" IsCheckable="True" IsChecked="False" x:Name="VstPanelMenuItem" Click="ToggleVstPanel_Click"/>
                            <MenuItem Header="Audio Files" IsCheckable="True" IsChecked="False" x:Name="AudioPanelMenuItem" Click="ToggleAudioPanel_Click"/>
                        </MenuItem>
                        <MenuItem Header="Project">
                            <MenuItem Header="_Add New Script..." Click="AddScript_Click"/>
                            <MenuItem Header="Import _Audio..." Click="ImportAudio_Click"/>
                            <Separator/>
                            <MenuItem Header="Add Project _Reference..." Click="AddReference_Click"/>
                            <Separator/>
                            <MenuItem Header="Project _Settings..." Click="ProjectSettings_Click"/>
                        </MenuItem>
                        <MenuItem Header="Run">
                            <MenuItem Header="_Run" InputGestureText="Ctrl+Enter" Click="RunScript_Click"/>
                            <MenuItem Header="_Stop" InputGestureText="Esc" Click="Stop_Click"/>
                        </MenuItem>
                        <MenuItem Header="Help">
                            <MenuItem Header="_Documentation" Click="Documentation_Click"/>
                            <MenuItem Header="_About" Click="About_Click"/>
                        </MenuItem>
                    </Menu>
                </StackPanel>

                <!-- Center: Window Title -->
                <TextBlock Grid.Column="1" Text="MusicEngine Editor"
                           Foreground="#6F737A" FontSize="12" FontWeight="Normal"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsHitTestVisible="False"/>

                <!-- Right: Window Control Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Stretch">
                    <!-- Minimize Button -->
                    <Button x:Name="MinimizeButton" Click="MinimizeButton_Click"
                            Width="46" Background="Transparent" BorderThickness="0"
                            VerticalAlignment="Stretch" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="border" Background="Transparent">
                                                <Path Data="M 0,0 H 10" Stroke="#BCBEC4" StrokeThickness="1"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="border" Property="Background" Value="#3C3F41"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Maximize/Restore Button -->
                    <Button x:Name="MaximizeButton" Click="MaximizeButton_Click"
                            Width="46" Background="Transparent" BorderThickness="0"
                            VerticalAlignment="Stretch" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="border" Background="Transparent">
                                                <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <!-- Maximize icon (square) -->
                                                    <Rectangle x:Name="MaximizeIcon" Width="10" Height="10"
                                                               Stroke="#BCBEC4" StrokeThickness="1" Fill="Transparent"/>
                                                    <!-- Restore icon (two overlapping squares) - hidden by default -->
                                                    <Canvas x:Name="RestoreIcon" Width="10" Height="10" Visibility="Collapsed">
                                                        <Rectangle Width="8" Height="8" Stroke="#BCBEC4" StrokeThickness="1"
                                                                   Fill="Transparent" Canvas.Left="2" Canvas.Top="0"/>
                                                        <Rectangle Width="8" Height="8" Stroke="#BCBEC4" StrokeThickness="1"
                                                                   Fill="#1E1F22" Canvas.Left="0" Canvas.Top="2"/>
                                                    </Canvas>
                                                </Grid>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="border" Property="Background" Value="#3C3F41"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Close Button -->
                    <Button x:Name="CloseButton" Click="CloseButton_Click"
                            Width="46" Background="Transparent" BorderThickness="0"
                            VerticalAlignment="Stretch" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="border" Background="Transparent">
                                                <Path Data="M 0,0 L 10,10 M 10,0 L 0,10" Stroke="#BCBEC4" StrokeThickness="1"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="border" Property="Background" Value="#E81123"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Toolbar -->
        <Border Grid.Row="1" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#2B2D30" Offset="0"/>
                    <GradientStop Color="#27292C" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <DockPanel Margin="10,8">
                <!-- Left: Project Buttons -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <Button Style="{StaticResource IconButtonStyle}" Click="NewProject_Click" ToolTip="New Project (Ctrl+Shift+N)">
                        <TextBlock Text="+" FontSize="16" FontWeight="Bold"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="OpenProject_Click" ToolTip="Open Project (Ctrl+Shift+O)" Margin="4,0,0,0">
                        <TextBlock Text="&#x1F4C2;" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="SaveAll_Click" ToolTip="Save All (Ctrl+Shift+S)" Margin="4,0,0,0">
                        <TextBlock Text="&#x1F4BE;" FontSize="14"/>
                    </Button>

                    <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="14,4"/>

                    <!-- Run Controls -->
                    <Button x:Name="RunButton" Content="Run" Style="{StaticResource RunButtonStyle}" Click="RunScript_Click" ToolTip="Execute Script (Ctrl+Enter)"/>
                    <Button Content="Stop" Style="{StaticResource StopButtonStyle}" Click="Stop_Click" ToolTip="Stop (Esc)" Margin="8,0,0,0"/>
                </StackPanel>

                <!-- Right: Sequencer Status -->
                <Border DockPanel.Dock="Right" CornerRadius="6" Padding="14,6" Margin="8,0,0,0">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="#252628" Offset="0"/>
                            <GradientStop Color="#1E1F22" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>
                    <Border.Effect>
                        <DropShadowEffect Color="#000000" BlurRadius="4" ShadowDepth="1" Opacity="0.2"/>
                    </Border.Effect>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="BPM" Foreground="{StaticResource SecondaryForegroundBrush}"
                                   VerticalAlignment="Center" Margin="0,0,8,0" FontSize="11"/>
                        <TextBox x:Name="BpmBox" Text="120" Width="50"
                                 Style="{StaticResource InputTextBoxStyle}"
                                 VerticalAlignment="Center"
                                 TextAlignment="Center"
                                 FontWeight="SemiBold"
                                 KeyDown="BpmBox_KeyDown"/>

                        <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="14,2"/>

                        <TextBlock Text="Patterns" Foreground="{StaticResource SecondaryForegroundBrush}"
                                   VerticalAlignment="Center" Margin="0,0,8,0" FontSize="11"/>
                        <Border Background="{StaticResource AccentBrush}" CornerRadius="10" Padding="8,2" MinWidth="24">
                            <TextBlock x:Name="PatternCountDisplay" Text="0"
                                       Foreground="White"
                                       FontWeight="Bold" FontSize="11"
                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- Center: Spacer -->
                <Border Background="Transparent" HorizontalAlignment="Stretch"/>
            </DockPanel>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240" MinWidth="180" x:Name="LeftPanelColumn"/>
                <ColumnDefinition Width="1"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="1" x:Name="RightSplitterColumn"/>
                <ColumnDefinition Width="0" MinWidth="0" x:Name="RightPanelColumn"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Project Explorer / Workshop -->
            <Grid Grid.Column="0">
                <!-- Project Explorer Panel -->
                <Border Background="{StaticResource PanelBackgroundBrush}" x:Name="ProjectExplorerPanel">
                    <DockPanel>
                        <!-- Panel Header -->
                        <Border DockPanel.Dock="Top" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                    <GradientStop Color="#2B2D30" Offset="0"/>
                                    <GradientStop Color="#252628" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <DockPanel Margin="12,10">
                                <TextBlock Text="Project"
                                           FontWeight="SemiBold"
                                           Foreground="{StaticResource BrightForegroundBrush}"
                                           FontSize="12"
                                           VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Style="{StaticResource IconButtonStyle}" ToolTip="Refresh" Width="22" Height="22">
                                        <TextBlock Text="&#x21BB;" FontSize="12"/>
                                    </Button>
                                </StackPanel>
                            </DockPanel>
                        </Border>

                        <!-- Project Tree -->
                        <TreeView x:Name="ProjectTree"
                                  Background="Transparent"
                                  BorderThickness="0"
                                  Padding="8,6"
                                  MouseDoubleClick="ProjectTree_MouseDoubleClick"/>
                    </DockPanel>
                </Border>

                <!-- Workshop Panel (hidden by default) -->
                <controls:WorkshopPanel x:Name="WorkshopPanel" Visibility="Collapsed"/>
            </Grid>

            <!-- Left Splitter -->
            <GridSplitter Grid.Column="1" Width="1" HorizontalAlignment="Stretch" ResizeDirection="Columns"
                          Background="{StaticResource BorderBrush}"/>

            <!-- Center: Editor + Output -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" MinHeight="150"/>
                    <RowDefinition Height="Auto" x:Name="OutputSplitterRow"/>
                    <RowDefinition Height="Auto" x:Name="OutputPanelRow"/>
                </Grid.RowDefinitions>

                <!-- Code Editor Area -->
                <Border Grid.Row="0" Background="{StaticResource EditorBackgroundBrush}">
                    <DockPanel>
                        <!-- Tab Bar -->
                        <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                            <TabControl x:Name="EditorTabs"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        SelectionChanged="EditorTabs_SelectionChanged">
                                <TabControl.ItemContainerStyle>
                                    <Style TargetType="TabItem">
                                        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Padding" Value="0"/>
                                        <Setter Property="Margin" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TabItem">
                                                    <Border x:Name="Border"
                                                            Background="{TemplateBinding Background}"
                                                            BorderThickness="0,0,1,2"
                                                            BorderBrush="{StaticResource BorderBrush}"
                                                            Padding="14,8">
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="&#x1F4C4;" FontSize="12" Margin="0,0,6,0"
                                                                       Foreground="{StaticResource SecondaryForegroundBrush}"/>
                                                            <ContentPresenter ContentSource="Header" VerticalAlignment="Center"/>
                                                            <Button Content="&#x2715;" Margin="10,0,0,0"
                                                                    Background="Transparent"
                                                                    BorderThickness="0"
                                                                    Foreground="{StaticResource SecondaryForegroundBrush}"
                                                                    FontSize="10"
                                                                    Padding="4,2"
                                                                    Cursor="Hand"
                                                                    Click="CloseTab_Click"
                                                                    Tag="{Binding RelativeSource={RelativeSource TemplatedParent}}">
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <Style.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}"/>
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </StackPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter TargetName="Border" Property="Background" Value="{StaticResource EditorBackgroundBrush}"/>
                                                            <Setter TargetName="Border" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                                        </Trigger>
                                                        <MultiTrigger>
                                                            <MultiTrigger.Conditions>
                                                                <Condition Property="IsSelected" Value="False"/>
                                                                <Condition Property="IsMouseOver" Value="True"/>
                                                            </MultiTrigger.Conditions>
                                                            <Setter TargetName="Border" Property="Background" Value="#3C3F41"/>
                                                        </MultiTrigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TabControl.ItemContainerStyle>
                            </TabControl>
                        </Border>

                        <!-- Find/Replace Control -->
                        <controls:FindReplaceControl x:Name="FindReplaceBar" DockPanel.Dock="Top"/>

                        <!-- Code Editor -->
                        <avalonedit:TextEditor
                            x:Name="CodeEditor"
                            FontFamily="JetBrains Mono, Cascadia Code, Consolas, Courier New"
                            FontSize="13"
                            ShowLineNumbers="True"
                            Background="{StaticResource EditorBackgroundBrush}"
                            Foreground="{StaticResource ForegroundBrush}"
                            LineNumbersForeground="{StaticResource SecondaryForegroundBrush}"
                            Padding="8,4"
                            VerticalScrollBarVisibility="Auto"
                            HorizontalScrollBarVisibility="Auto"/>
                    </DockPanel>
                </Border>

                <!-- Splitter for Output -->
                <GridSplitter Grid.Row="1" Height="1" HorizontalAlignment="Stretch" ResizeDirection="Rows"
                              Background="{StaticResource BorderBrush}" x:Name="OutputSplitter"/>

                <!-- Output Panel (Collapsible) -->
                <Border Grid.Row="2" Background="{StaticResource PanelBackgroundBrush}" x:Name="OutputPanel" Height="200">
                    <DockPanel>
                        <!-- Output Header -->
                        <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                            <DockPanel Margin="0">
                                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                                    <Button Content="Clear" Style="{StaticResource ToolbarButtonStyle}"
                                            Click="ClearOutput_Click" FontSize="11" Padding="10,6" Margin="4"/>
                                    <Button Content="&#x2715;" Style="{StaticResource IconButtonStyle}"
                                            Click="ToggleOutput_Click" ToolTip="Close Output" Margin="0,4,4,4"
                                            Width="24" Height="24"/>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal">
                                    <Border x:Name="OutputTabHeader" Background="{StaticResource AccentBrush}" Padding="14,8" Cursor="Hand" MouseDown="OutputTab_Click">
                                        <TextBlock Text="Output" FontWeight="SemiBold" Foreground="White" FontSize="11"/>
                                    </Border>
                                    <Border x:Name="ProblemsTabHeader" Background="Transparent" Padding="14,8" Cursor="Hand" MouseDown="ProblemsTab_Click">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Problems" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                                            <Border x:Name="ErrorCountBadge" Background="{StaticResource ErrorBrush}" CornerRadius="8"
                                                    Padding="6,2" Margin="6,0,0,0" Visibility="Collapsed">
                                                <TextBlock x:Name="ErrorCountText" Text="0" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                            </Border>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </DockPanel>
                        </Border>

                        <!-- Output/Problems Content -->
                        <Grid>
                            <!-- Output Content -->
                            <TextBox x:Name="OutputBox"
                                     Style="{StaticResource OutputTextBoxStyle}"
                                     TextWrapping="NoWrap"
                                     AcceptsReturn="True"/>

                            <!-- Problems List -->
                            <ListView x:Name="ProblemsListView" Visibility="Collapsed"
                                      Background="Transparent" BorderThickness="0"
                                      Foreground="{StaticResource ForegroundBrush}"
                                      MouseDoubleClick="ProblemsListView_DoubleClick">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="" Width="24">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Icon}" Foreground="{Binding IconColor}" FontSize="12"/>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="Description" Width="400" DisplayMemberBinding="{Binding Message}"/>
                                        <GridViewColumn Header="File" Width="150" DisplayMemberBinding="{Binding FileName}"/>
                                        <GridViewColumn Header="Line" Width="50" DisplayMemberBinding="{Binding Line}"/>
                                        <GridViewColumn Header="Col" Width="50" DisplayMemberBinding="{Binding Column}"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                    </DockPanel>
                </Border>
            </Grid>

            <!-- Right Splitter -->
            <GridSplitter Grid.Column="3" Width="1" HorizontalAlignment="Stretch" ResizeDirection="Columns"
                          Background="{StaticResource BorderBrush}" x:Name="RightSplitter" Visibility="Collapsed"/>

            <!-- Right Panel (MIDI/VST/Audio) -->
            <Border Grid.Column="4" Background="{StaticResource PanelBackgroundBrush}" x:Name="RightPanel" Visibility="Collapsed">
                <DockPanel>
                    <!-- Panel Header with Tabs -->
                    <Border DockPanel.Dock="Top" Background="{StaticResource HeaderBackgroundBrush}"
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                        <DockPanel>
                            <Button Content="&#x2715;" Style="{StaticResource IconButtonStyle}"
                                    Click="CloseRightPanel_Click" ToolTip="Close Panel" DockPanel.Dock="Right"
                                    Width="24" Height="24" Margin="4"/>
                            <StackPanel Orientation="Horizontal">
                                <Border x:Name="MidiTabHeader" Background="{StaticResource AccentBrush}" Padding="12,8" Cursor="Hand" MouseDown="MidiTab_Click">
                                    <TextBlock Text="MIDI" FontWeight="SemiBold" Foreground="White" FontSize="11"/>
                                </Border>
                                <Border x:Name="VstTabHeader" Background="Transparent" Padding="12,8" Cursor="Hand" MouseDown="VstTab_Click">
                                    <TextBlock Text="VST" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                                </Border>
                                <Border x:Name="AudioTabHeader" Background="Transparent" Padding="12,8" Cursor="Hand" MouseDown="AudioTab_Click">
                                    <TextBlock Text="Audio" Foreground="{StaticResource SecondaryForegroundBrush}" FontSize="11"/>
                                </Border>
                            </StackPanel>
                        </DockPanel>
                    </Border>

                    <!-- Tab Content -->
                    <Grid>
                        <!-- MIDI Devices Panel -->
                        <Border x:Name="MidiDevicesPanel" Visibility="Visible" Padding="8">
                            <DockPanel>
                                <Button Content="Refresh Devices" Style="{StaticResource ToolbarButtonStyle}"
                                        DockPanel.Dock="Top" Click="RefreshMidiDevices_Click" Margin="0,0,0,8"/>

                                <!-- Section Headers -->
                                <TextBlock DockPanel.Dock="Top" Text="Connected MIDI Devices"
                                           Foreground="{StaticResource SecondaryForegroundBrush}"
                                           FontSize="10" Margin="0,0,0,8"/>

                                <ListBox x:Name="MidiDevicesList" Background="Transparent" BorderThickness="0"
                                         Foreground="{StaticResource ForegroundBrush}"
                                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">
                                            <Setter Property="Padding" Value="0"/>
                                            <Setter Property="Margin" Value="0,0,0,4"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ListBoxItem">
                                                        <Border x:Name="Border" Background="{TemplateBinding Background}"
                                                                BorderBrush="{StaticResource BorderBrush}"
                                                                BorderThickness="1" CornerRadius="4" Padding="10,8">
                                                            <ContentPresenter/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="Border" Property="Background" Value="#3C3F41"/>
                                                            </Trigger>
                                                            <Trigger Property="IsSelected" Value="True">
                                                                <Setter TargetName="Border" Property="Background" Value="#4B6EAF"/>
                                                                <Setter TargetName="Border" Property="BorderBrush" Value="#4B6EAF"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <!-- Device Name Row -->
                                                <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                    <!-- Type indicator icon -->
                                                    <TextBlock Text="{Binding TypeIcon}"
                                                               Foreground="{Binding TypeColor}"
                                                               FontSize="12" VerticalAlignment="Center"
                                                               Margin="0,0,6,0" FontWeight="Bold"/>
                                                    <!-- Device Name -->
                                                    <TextBlock Text="{Binding Name}"
                                                               Foreground="{StaticResource BrightForegroundBrush}"
                                                               FontWeight="SemiBold" FontSize="12"
                                                               TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>

                                                <!-- Type and Channel Info Row -->
                                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="18,4,0,0">
                                                    <!-- Type Badge -->
                                                    <Border Background="{Binding TypeColor}" CornerRadius="3"
                                                            Padding="6,2" Margin="0,0,8,0">
                                                        <TextBlock Text="{Binding Type}" Foreground="White"
                                                                   FontSize="10" FontWeight="SemiBold"/>
                                                    </Border>
                                                    <!-- Channel Info -->
                                                    <TextBlock Text="{Binding DisplayChannel}"
                                                               Foreground="{StaticResource SecondaryForegroundBrush}"
                                                               FontSize="11" VerticalAlignment="Center"/>
                                                    <!-- Device Index (for scripting reference) -->
                                                    <TextBlock Text=" - Index: " Foreground="{StaticResource SecondaryForegroundBrush}"
                                                               FontSize="10" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                                    <TextBlock Text="{Binding DeviceIndex}"
                                                               Foreground="{StaticResource AccentBrush}"
                                                               FontSize="10" FontWeight="Bold" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </DockPanel>
                        </Border>

                        <!-- VST Plugins Panel (Enhanced) -->
                        <controls:VstPluginPanel x:Name="VstPluginsPanel" Visibility="Collapsed"/>

                        <!-- Audio Files Panel -->
                        <Border x:Name="AudioFilesPanel" Visibility="Collapsed" Padding="8"
                                AllowDrop="True" Drop="AudioFilesPanel_Drop" DragOver="AudioFilesPanel_DragOver">
                            <DockPanel>
                                <Button Content="Import Audio" Style="{StaticResource ToolbarButtonStyle}"
                                        DockPanel.Dock="Top" Click="ImportAudio_Click" Margin="0,0,0,8"/>
                                <Border x:Name="AudioDropZone" BorderBrush="{StaticResource BorderBrush}"
                                        BorderThickness="2" CornerRadius="4" Margin="0,0,0,8"
                                        Background="Transparent" Padding="16"
                                        AllowDrop="True" Drop="AudioFilesPanel_Drop" DragOver="AudioFilesPanel_DragOver">
                                    <TextBlock Text="Drop audio files here"
                                               Foreground="{StaticResource SecondaryForegroundBrush}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ListView x:Name="AudioFilesList" Background="Transparent" BorderThickness="0"
                                          Foreground="{StaticResource ForegroundBrush}" MouseDoubleClick="AudioFile_DoubleClick">
                                    <ListView.View>
                                        <GridView>
                                            <GridViewColumn Header="Name" Width="140" DisplayMemberBinding="{Binding Alias}"/>
                                            <GridViewColumn Header="Duration" Width="60" DisplayMemberBinding="{Binding Duration}"/>
                                            <GridViewColumn Header="Format" Width="50" DisplayMemberBinding="{Binding Format}"/>
                                        </GridView>
                                    </ListView.View>
                                </ListView>
                            </DockPanel>
                        </Border>
                    </Grid>
                </DockPanel>
            </Border>

            <!-- Right Sidebar Tool Buttons -->
            <Border Grid.Column="5" Background="{StaticResource ToolbarBackgroundBrush}"
                    BorderBrush="{StaticResource BorderBrush}" BorderThickness="1,0,0,0">
                <StackPanel Orientation="Vertical" Width="36">
                    <Button Style="{StaticResource IconButtonStyle}" Click="ToggleMidiPanel_Click"
                            ToolTip="MIDI Devices" Margin="4" x:Name="MidiToolButton">
                        <TextBlock Text="M" FontWeight="Bold" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="ToggleVstPanel_Click"
                            ToolTip="VST Plugins" Margin="4" x:Name="VstToolButton">
                        <TextBlock Text="V" FontWeight="Bold" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}" Click="ToggleAudioPanel_Click"
                            ToolTip="Audio Files" Margin="4" x:Name="AudioToolButton">
                        <TextBlock Text="A" FontWeight="Bold" FontSize="14"/>
                    </Button>

                    <Rectangle Height="1" Fill="{StaticResource BorderBrush}" Margin="6,8"/>

                    <Button Style="{StaticResource IconButtonStyle}" Click="ToggleOutput_Click"
                            ToolTip="Toggle Output" Margin="4" x:Name="OutputToolButton">
                        <TextBlock Text="O" FontWeight="Bold" FontSize="14"/>
                    </Button>

                    <Rectangle Height="1" Fill="{StaticResource BorderBrush}" Margin="6,8"/>

                    <Button Style="{StaticResource IconButtonStyle}" Click="ToggleWorkshop_Click"
                            ToolTip="Workshop Tutorials" Margin="4" x:Name="WorkshopToolButton">
                        <TextBlock Text="W" FontWeight="Bold" FontSize="14"/>
                    </Button>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3">
            <StatusBar.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#2B2D30" Offset="0"/>
                    <GradientStop Color="#27292C" Offset="1"/>
                </LinearGradientBrush>
            </StatusBar.Background>
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <Border Width="8" Height="8" CornerRadius="4" Margin="0,0,8,0">
                        <Border.Background>
                            <RadialGradientBrush>
                                <GradientStop Color="#6AAB73" Offset="0"/>
                                <GradientStop Color="#499C54" Offset="1"/>
                            </RadialGradientBrush>
                        </Border.Background>
                        <Border.Effect>
                            <DropShadowEffect Color="#6AAB73" BlurRadius="4" ShadowDepth="0" Opacity="0.5"/>
                        </Border.Effect>
                    </Border>
                    <TextBlock x:Name="StatusText" Text="Ready" FontWeight="Medium"/>
                    <Ellipse x:Name="StatusIndicator" Width="0" Height="0" Fill="{StaticResource SuccessBrush}" Visibility="Collapsed"/>
                </StackPanel>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="ProjectNameDisplay" Text="No project loaded"
                           Foreground="{StaticResource SecondaryForegroundBrush}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock x:Name="FileNameDisplay" Text=""/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <Border Background="#1E1F22" CornerRadius="3" Padding="8,2" Margin="0,0,12,0">
                        <TextBlock x:Name="CaretPositionDisplay" Text="Ln 1, Col 1" FontSize="11"/>
                    </Border>
                  
                    <TextBlock Text="|" Foreground="{StaticResource BorderBrush}" Margin="0,0,8,0" FontSize="11"/>
                  
                    <Border Background="{StaticResource AccentBrush}" CornerRadius="3" Padding="6,2">
                        <TextBlock Text="UTF-8" Foreground="White" FontSize="10" FontWeight="SemiBold"/>
                    </Border>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
