<UserControl x:Class="MusicEngineEditor.Views.PolyphonicPitchView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:MusicEngineEditor.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000"
             d:DataContext="{d:DesignInstance Type=vm:PolyphonicPitchViewModel}"
             Background="#0D0D0D">

    <UserControl.Resources>
        <!-- Dark Theme Colors -->
        <Color x:Key="BackgroundColor">#0D0D0D</Color>
        <Color x:Key="PanelColor">#181818</Color>
        <Color x:Key="BorderColor">#2A2A2A</Color>
        <Color x:Key="GridLineColor">#1F1F1F</Color>
        <Color x:Key="TextPrimaryColor">#E0E0E0</Color>
        <Color x:Key="TextSecondaryColor">#808080</Color>
        <Color x:Key="AccentColor">#00D9FF</Color>
        <Color x:Key="AccentSecondaryColor">#00FF88</Color>
        <Color x:Key="ButtonHoverColor">#252525</Color>
        <Color x:Key="ButtonActiveColor">#00D9FF</Color>
        <Color x:Key="DangerColor">#FF4757</Color>
        <Color x:Key="WarningColor">#FFA500</Color>
        <Color x:Key="SuccessColor">#00FF88</Color>
        <Color x:Key="ModifiedColor">#FFD700</Color>
        <Color x:Key="PlayheadColor">#FF6B6B</Color>

        <!-- Brushes -->
        <SolidColorBrush x:Key="BackgroundBrush" Color="{StaticResource BackgroundColor}"/>
        <SolidColorBrush x:Key="PanelBrush" Color="{StaticResource PanelColor}"/>
        <SolidColorBrush x:Key="BorderBrush" Color="{StaticResource BorderColor}"/>
        <SolidColorBrush x:Key="GridLineBrush" Color="{StaticResource GridLineColor}"/>
        <SolidColorBrush x:Key="TextPrimaryBrush" Color="{StaticResource TextPrimaryColor}"/>
        <SolidColorBrush x:Key="TextSecondaryBrush" Color="{StaticResource TextSecondaryColor}"/>
        <SolidColorBrush x:Key="AccentBrush" Color="{StaticResource AccentColor}"/>
        <SolidColorBrush x:Key="AccentSecondaryBrush" Color="{StaticResource AccentSecondaryColor}"/>
        <SolidColorBrush x:Key="PlayheadBrush" Color="{StaticResource PlayheadColor}"/>
        <SolidColorBrush x:Key="ModifiedBrush" Color="{StaticResource ModifiedColor}"/>

        <!-- Note Blob Gradient -->
        <LinearGradientBrush x:Key="NoteBlobGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#00D9FF" Offset="0"/>
            <GradientStop Color="#00FF88" Offset="1"/>
        </LinearGradientBrush>

        <!-- Selected Note Gradient -->
        <LinearGradientBrush x:Key="SelectedNoteBlobGradient" StartPoint="0,0" EndPoint="1,1">
            <GradientStop Color="#FFFFFF" Offset="0"/>
            <GradientStop Color="#00D9FF" Offset="1"/>
        </LinearGradientBrush>

        <!-- Value Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Toolbar Button Style -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="MinWidth" Value="28"/>
            <Setter Property="MinHeight" Value="26"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="{StaticResource ButtonHoverColor}"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="{StaticResource AccentColor}"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Toggle Button Style for Tools -->
        <Style x:Key="ToolToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="1,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="MinWidth" Value="32"/>
            <Setter Property="MinHeight" Value="26"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="{StaticResource ButtonHoverColor}"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="{StaticResource AccentColor}"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="border" Property="BorderBrush">
                                    <Setter.Value>
                                        <SolidColorBrush Color="{StaticResource AccentColor}"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                <Setter TargetName="border" Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- CheckBox Style -->
        <Style x:Key="DarkCheckBoxStyle" TargetType="CheckBox">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- ComboBox Style -->
        <Style x:Key="DarkComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="{StaticResource PanelBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="MinWidth" Value="80"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <!-- Slider Style -->
        <Style x:Key="DarkSliderStyle" TargetType="Slider">
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Maximum" Value="1"/>
            <Setter Property="Width" Value="80"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="4,0"/>
        </Style>

        <!-- Progress Bar Style -->
        <Style x:Key="AnalysisProgressStyle" TargetType="ProgressBar">
            <Setter Property="Height" Value="4"/>
            <Setter Property="Background" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <!-- Separator Style -->
        <Style x:Key="VerticalSeparatorStyle" TargetType="Rectangle">
            <Setter Property="Width" Value="1"/>
            <Setter Property="Fill" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Margin" Value="8,4"/>
        </Style>

    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <!-- Top Toolbar -->
            <RowDefinition Height="Auto"/>
            <!-- Secondary Toolbar -->
            <RowDefinition Height="Auto"/>
            <!-- Analysis Progress -->
            <RowDefinition Height="Auto"/>
            <!-- Main Content -->
            <RowDefinition Height="*"/>
            <!-- Status Bar -->
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Toolbar -->
        <Border Grid.Row="0"
                Background="{StaticResource PanelBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <DockPanel>
                <!-- Left Section: File and Analysis -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <!-- Load/Analyze Buttons -->
                    <Button Content="Load Audio"
                            Style="{StaticResource ToolbarButtonStyle}"
                            ToolTip="Load audio file for analysis"
                            Click="OnLoadAudioClick"/>

                    <Button Content="Analyze"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding AnalyzeCommand}"
                            ToolTip="Analyze loaded audio (Ctrl+A)"
                            Margin="4,0,0,0"/>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Tool Selection -->
                    <Border Background="#252629" CornerRadius="4" Padding="2">
                        <StackPanel Orientation="Horizontal">
                            <ToggleButton x:Name="SelectToolButton"
                                          Style="{StaticResource ToolToggleButtonStyle}"
                                          IsChecked="True"
                                          ToolTip="Select Tool (V)"
                                          Command="{Binding SetToolCommand}"
                                          CommandParameter="{x:Static vm:PolyphonicPitchTool.Select}"
                                          Content="Sel"/>
                            <ToggleButton x:Name="PitchToolButton"
                                          Style="{StaticResource ToolToggleButtonStyle}"
                                          ToolTip="Pitch Correction Tool (P)"
                                          Command="{Binding SetToolCommand}"
                                          CommandParameter="{x:Static vm:PolyphonicPitchTool.PitchCorrect}"
                                          Content="Pitch"/>
                            <ToggleButton x:Name="TimeToolButton"
                                          Style="{StaticResource ToolToggleButtonStyle}"
                                          ToolTip="Time Correction Tool (T)"
                                          Command="{Binding SetToolCommand}"
                                          CommandParameter="{x:Static vm:PolyphonicPitchTool.TimeCorrect}"
                                          Content="Time"/>
                            <ToggleButton x:Name="FormantToolButton"
                                          Style="{StaticResource ToolToggleButtonStyle}"
                                          ToolTip="Formant Tool (F)"
                                          Command="{Binding SetToolCommand}"
                                          CommandParameter="{x:Static vm:PolyphonicPitchTool.Formant}"
                                          Content="Form"/>
                            <ToggleButton x:Name="SplitToolButton"
                                          Style="{StaticResource ToolToggleButtonStyle}"
                                          ToolTip="Split Tool (S)"
                                          Command="{Binding SetToolCommand}"
                                          CommandParameter="{x:Static vm:PolyphonicPitchTool.Split}"
                                          Content="Split"/>
                        </StackPanel>
                    </Border>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Edit Actions -->
                    <Button Content="Undo"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding UndoCommand}"
                            ToolTip="{Binding UndoDescription, StringFormat='Undo: {0}'}"/>
                    <Button Content="Redo"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding RedoCommand}"
                            ToolTip="{Binding RedoDescription, StringFormat='Redo: {0}'}"/>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Selection Actions -->
                    <Button Content="Select All"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding SelectAllCommand}"
                            ToolTip="Select All Notes (Ctrl+A)"/>
                    <Button Content="Delete"
                            Command="{Binding DeleteSelectedCommand}"
                            ToolTip="Delete Selected Notes (Del)">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource ToolbarButtonStyle}">
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Foreground">
                                            <Setter.Value>
                                                <SolidColorBrush Color="{StaticResource DangerColor}"/>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>

                <!-- Right Section: Zoom and View -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                    <!-- Zoom Controls -->
                    <TextBlock Text="Zoom:"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Margin="0,0,4,0"/>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="X" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" Margin="0,0,2,0"/>
                        <Button Content="-" Style="{StaticResource ToolbarButtonStyle}" Command="{Binding ZoomOutXCommand}" ToolTip="Zoom Out Horizontal"/>
                        <Button Content="+" Style="{StaticResource ToolbarButtonStyle}" Command="{Binding ZoomInXCommand}" ToolTip="Zoom In Horizontal"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="4,0,0,0">
                        <TextBlock Text="Y" FontSize="10" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" Margin="0,0,2,0"/>
                        <Button Content="-" Style="{StaticResource ToolbarButtonStyle}" Command="{Binding ZoomOutYCommand}" ToolTip="Zoom Out Vertical"/>
                        <Button Content="+" Style="{StaticResource ToolbarButtonStyle}" Command="{Binding ZoomInYCommand}" ToolTip="Zoom In Vertical"/>
                    </StackPanel>
                    <Button Content="Fit" Style="{StaticResource ToolbarButtonStyle}" Command="{Binding ZoomToFitCommand}" ToolTip="Zoom to Fit All Notes" Margin="4,0,0,0"/>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Apply Changes -->
                    <Button Content="Apply"
                            Command="{Binding ApplyCommand}"
                            ToolTip="Apply all changes to audio"
                            Padding="12,4">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource ToolbarButtonStyle}">
                                <Setter Property="Background">
                                    <Setter.Value>
                                        <SolidColorBrush Color="#1A3D1A"/>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <SolidColorBrush Color="{StaticResource SuccessColor}"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Setter Property="Foreground" Value="Black"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>

                <!-- Center Spacer -->
                <Border/>
            </DockPanel>
        </Border>

        <!-- Secondary Toolbar: Pitch/Formant Options -->
        <Border Grid.Row="1"
                Background="{StaticResource PanelBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <DockPanel>
                <!-- Left: Pitch Options -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <!-- Quantization -->
                    <TextBlock Text="Quantize:"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Margin="0,0,4,0"/>
                    <ComboBox x:Name="ScaleComboBox"
                              Style="{StaticResource DarkComboBoxStyle}"
                              ItemsSource="{Binding AvailableScales}"
                              SelectedItem="{Binding SelectedScale}"
                              MinWidth="100"
                              ToolTip="Scale for quantization"/>
                    <ComboBox x:Name="RootNoteComboBox"
                              Style="{StaticResource DarkComboBoxStyle}"
                              ItemsSource="{Binding AvailableRootNotes}"
                              SelectedItem="{Binding SelectedRootNote}"
                              MinWidth="50"
                              Margin="4,0,0,0"
                              ToolTip="Root note for scale"/>
                    <TextBlock Text="Strength:"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Margin="8,0,4,0"/>
                    <Slider x:Name="QuantizeStrengthSlider"
                            Style="{StaticResource DarkSliderStyle}"
                            Value="{Binding QuantizationStrength}"
                            ToolTip="Quantization strength"/>
                    <Button Content="Q"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding QuantizePitchSelectedCommand}"
                            ToolTip="Quantize selected notes to semitone"
                            Margin="4,0,0,0"/>
                    <Button Content="Scale"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding QuantizeToScaleCommand}"
                            ToolTip="Quantize all notes to scale"
                            Margin="2,0,0,0"/>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Transpose -->
                    <TextBlock Text="Transpose:"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Margin="0,0,4,0"/>
                    <Button Content="-12"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding TransposeSelectedCommand}"
                            CommandParameter="-12"
                            ToolTip="Transpose down octave"/>
                    <Button Content="-1"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding TransposeSelectedCommand}"
                            CommandParameter="-1"
                            ToolTip="Transpose down semitone"/>
                    <Button Content="+1"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding TransposeSelectedCommand}"
                            CommandParameter="1"
                            ToolTip="Transpose up semitone"/>
                    <Button Content="+12"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding TransposeSelectedCommand}"
                            CommandParameter="12"
                            ToolTip="Transpose up octave"/>

                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}"/>

                    <!-- Formant -->
                    <CheckBox x:Name="PreserveFormantsCheckBox"
                              Style="{StaticResource DarkCheckBoxStyle}"
                              IsChecked="{Binding PreserveFormants}"
                              Content="Preserve Formants"
                              ToolTip="Preserve formants during pitch shifting"/>
                    <TextBlock Text="Formant:"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               VerticalAlignment="Center"
                               Margin="8,0,4,0"/>
                    <Button Content="-"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding SetFormantSelectedCommand}"
                            CommandParameter="-1"
                            ToolTip="Shift formant down"/>
                    <Button Content="0"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding ResetFormantSelectedCommand}"
                            ToolTip="Reset formant"/>
                    <Button Content="+"
                            Style="{StaticResource ToolbarButtonStyle}"
                            Command="{Binding SetFormantSelectedCommand}"
                            CommandParameter="1"
                            ToolTip="Shift formant up"/>
                </StackPanel>

                <!-- Right: Display Options -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                    <CheckBox Style="{StaticResource DarkCheckBoxStyle}"
                              IsChecked="{Binding ShowPitchDrift}"
                              Content="Pitch Drift"
                              ToolTip="Show pitch drift visualization"/>
                    <CheckBox Style="{StaticResource DarkCheckBoxStyle}"
                              IsChecked="{Binding ShowPitchGrid}"
                              Content="Grid"
                              ToolTip="Show pitch grid"/>
                    <CheckBox Style="{StaticResource DarkCheckBoxStyle}"
                              IsChecked="{Binding ShowVoiceColors}"
                              Content="Colors"
                              ToolTip="Show voice colors"/>
                    <CheckBox Style="{StaticResource DarkCheckBoxStyle}"
                              IsChecked="{Binding HighlightModified}"
                              Content="Modified"
                              ToolTip="Highlight modified notes"/>
                </StackPanel>

                <!-- Center Spacer -->
                <Border/>
            </DockPanel>
        </Border>

        <!-- Analysis Progress Bar -->
        <ProgressBar Grid.Row="2"
                     Style="{StaticResource AnalysisProgressStyle}"
                     Value="{Binding AnalysisProgress}"
                     Maximum="1"
                     Visibility="{Binding IsAnalyzing, Converter={StaticResource BooleanToVisibilityConverter}}"/>

        <!-- Main Content Area -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <!-- Voice List Panel -->
                <ColumnDefinition Width="120"/>
                <!-- Piano Keyboard -->
                <ColumnDefinition Width="60"/>
                <!-- Note Canvas -->
                <ColumnDefinition Width="*"/>
                <!-- Vertical ScrollBar -->
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <!-- Time Ruler -->
                <RowDefinition Height="24"/>
                <!-- Main Canvas -->
                <RowDefinition Height="*"/>
                <!-- Horizontal ScrollBar -->
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Voice List Panel -->
            <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                    Background="{StaticResource PanelBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Voice List Header -->
                    <Border Grid.Row="0"
                            Background="#252629"
                            Padding="8,6">
                        <TextBlock Text="Voices"
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   FontSize="11"
                                   FontWeight="SemiBold"/>
                    </Border>

                    <!-- Voice List -->
                    <ListBox Grid.Row="1"
                             x:Name="VoiceListBox"
                             ItemsSource="{Binding Voices}"
                             Background="Transparent"
                             BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:VoiceViewModel}">
                                <Border Padding="4,2" Margin="2">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="16"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Voice Color Indicator -->
                                        <Ellipse Grid.Column="0"
                                                 Width="10" Height="10"
                                                 VerticalAlignment="Center">
                                            <Ellipse.Fill>
                                                <SolidColorBrush Color="{Binding DisplayColor}"/>
                                            </Ellipse.Fill>
                                        </Ellipse>

                                        <!-- Voice Name -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   Foreground="{StaticResource TextPrimaryBrush}"
                                                   FontSize="11"
                                                   VerticalAlignment="Center"
                                                   Margin="4,0,0,0"/>

                                        <!-- Note Count -->
                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding NoteCount}"
                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                   FontSize="10"
                                                   VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Empty State -->
                    <TextBlock Grid.Row="1"
                               Text="No voices detected"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontSize="11"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Visibility="{Binding HasAnalysis, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}"/>
                </Grid>
            </Border>

            <!-- Time Ruler -->
            <Border Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="2"
                    Background="#252629"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,0,0,1">
                <Canvas x:Name="TimeRulerCanvas" ClipToBounds="True">
                    <!-- Time ruler ticks drawn in code-behind -->
                </Canvas>
            </Border>

            <!-- Piano Keyboard -->
            <Canvas x:Name="PianoKeyboardCanvas"
                    Grid.Row="1" Grid.Column="1"
                    Background="{StaticResource PanelBrush}"
                    ClipToBounds="True">
                <!-- Piano keyboard drawn in code-behind -->
            </Canvas>

            <!-- Note Blob Canvas (Main Editor Area) -->
            <Border Grid.Row="1" Grid.Column="2"
                    Background="{StaticResource BackgroundBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1,0,0,0"
                    ClipToBounds="True">
                <Canvas x:Name="NoteBlobCanvas"
                        MouseLeftButtonDown="OnCanvasMouseLeftButtonDown"
                        MouseLeftButtonUp="OnCanvasMouseLeftButtonUp"
                        MouseMove="OnCanvasMouseMove"
                        MouseWheel="OnCanvasMouseWheel">
                    <!-- Note blobs and grid drawn in code-behind -->

                    <!-- Playhead Line -->
                    <Line x:Name="PlayheadLine"
                          Y1="0"
                          Y2="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Canvas}}"
                          Stroke="{StaticResource PlayheadBrush}"
                          StrokeThickness="1"/>

                    <!-- Selection Rectangle -->
                    <Rectangle x:Name="SelectionRectangle"
                               Stroke="{StaticResource AccentBrush}"
                               StrokeThickness="1"
                               StrokeDashArray="4,2"
                               Fill="#2000D9FF"
                               Visibility="Collapsed"/>
                </Canvas>
            </Border>

            <!-- Vertical ScrollBar -->
            <ScrollBar Grid.Row="1" Grid.Column="3"
                       x:Name="VerticalScrollBar"
                       Orientation="Vertical"
                       Minimum="{Binding LowestVisibleNote}"
                       Maximum="{Binding HighestVisibleNote}"
                       Value="{Binding ScrollY}"
                       ViewportSize="24"
                       SmallChange="1"
                       LargeChange="12"/>

            <!-- Horizontal ScrollBar -->
            <ScrollBar Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                       x:Name="HorizontalScrollBar"
                       Orientation="Horizontal"
                       Minimum="0"
                       Maximum="{Binding TotalDuration}"
                       Value="{Binding ScrollX}"
                       ViewportSize="5"
                       SmallChange="0.1"
                       LargeChange="1"/>

            <!-- Bottom-Left Corner (Voice panel scrollbar area) -->
            <Border Grid.Row="2" Grid.Column="0"
                    Background="{StaticResource PanelBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="0,1,1,0"/>

            <!-- Bottom-Right Corner -->
            <Border Grid.Row="2" Grid.Column="3"
                    Background="{StaticResource BackgroundBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1,1,0,0"
                    Width="17"/>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="4"
                Background="{StaticResource PanelBrush}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="8,4">
            <DockPanel>
                <!-- Left: Status Message -->
                <TextBlock DockPanel.Dock="Left"
                           Text="{Binding StatusMessage}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="11"
                           VerticalAlignment="Center"/>

                <!-- Right: Statistics -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <TextBlock Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center">
                        <Run Text="Notes: "/>
                        <Run Text="{Binding TotalNoteCount, Mode=OneWay}" Foreground="{StaticResource TextPrimaryBrush}"/>
                    </TextBlock>
                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}" Margin="8,2"/>
                    <TextBlock Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center">
                        <Run Text="Voices: "/>
                        <Run Text="{Binding VoiceCount, Mode=OneWay}" Foreground="{StaticResource TextPrimaryBrush}"/>
                    </TextBlock>
                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}" Margin="8,2"/>
                    <TextBlock Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center">
                        <Run Text="Duration: "/>
                        <Run Text="{Binding TotalDuration, StringFormat='{}{0:F2}s', Mode=OneWay}" Foreground="{StaticResource TextPrimaryBrush}"/>
                    </TextBlock>
                    <Rectangle Style="{StaticResource VerticalSeparatorStyle}" Margin="8,2"/>
                    <TextBlock Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center">
                        <Run Text="Selected: "/>
                        <Run Text="{Binding SelectedNotes.Count, Mode=OneWay}" Foreground="{StaticResource AccentBrush}"/>
                    </TextBlock>

                    <!-- Modified Indicator -->
                    <Border Margin="8,0,0,0"
                            Background="#3D3D00"
                            CornerRadius="2"
                            Padding="6,2"
                            Visibility="{Binding HasChanges, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="Modified"
                                   Foreground="{StaticResource ModifiedBrush}"
                                   FontSize="10"/>
                    </Border>
                </StackPanel>

                <!-- Center Spacer -->
                <Border/>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
